%!TEX root = draft.tex
\section{Normal Forward/Backward Simulations}\label{app:backSim}

We define a class of forward/backward simulations, called \emph{normal simulations}, that are used in the proofs in Appendix~\ref{app:absImplQueue} and Appendix~\ref{app:absImplStack}. 

\begin{definition}\label{def:for_app}
Let $L_1=(Q_1,\Sigma, s_0^1, \delta_1)$ and $L_2=(Q_2,\Sigma, s_0^2, \delta_2)$ be two libraries over alphabets $\Sigma_1$ and $\Sigma_2$, respectively, such that $C\cup R \subseteq \Sigma_1\cap\Sigma_2$, and $\Gamma$ a set of actions such that $C\cup R\subseteq \Gamma\subseteq \Sigma_1\cap\Sigma_2$. A relation $\mathit{fs} \subseteq Q_{1} \times Q_{2}$ is called a \emph{normal $\Gamma$-forward simulation} from $L_1$ to $L_2$ iff the following holds:
\begin{itemize}
\item[(i)] $\mathit{fs}[s_0^1] = \{s_0^2 \}$ 
\item[(ii-a)] If $(s,c,s') \in \delta_1$, for some $c\in C$, and $u \in \mathit{fs}[s]$, then there exists $u' \in \mathit{fs}[s']$ such that $u \xrightarrow{@s} u'$, $@s_0=c$, and $@s_i\in \Sigma_2\setminus\Gamma$, for each $0<i<|@s|$.
%$@s = a_1, a_2, ..., a_n$ such that $a_1 = inv(m,d,k)$ and for all $i \in [2,n]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. The expression $u \xrightarrow{a} u'$ means that there exists a sequence of states $u_1, u_2,...,u_{n+1}$ such that $u_1 = u$, $u_{n+1} = u'$ and for all $i \in [1,n]$, $(u_i, a_i, u_{i+1}) \in \delta_{L_2}$.
\item[(ii-b)] If $(s,r,s') \in \delta_{1}$, for some $r\in R$, and $u \in \mathit{fs}[s]$, then there exists $u' \in \mathit{fs}[s']$ such that $u \xrightarrow{@s} u'$, $@s_{|@s| -1}=r$, and $@s_i\in \Sigma_2\setminus\Gamma$, for each $0\leq i<|@s| -1$.
% where $a = a_1, a_2, ..., a_n$ such that $a_n = ret(m,d,k)$ and for all $i \in [1,n-1]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. 
\item[(ii-c)] If $(s, \gamma , s') \in \delta_1$, for some $\gamma\in \Gamma\setminus (C\cup R)$, and $u \in fs[s]$, then there exists $u' \in fs[s']$ such that $\delta_2(u,\gamma, u')$. 
\item[(ii-d)] If $(s,e,s') \in \delta_1$, for some $e \in \Sigma_1\setminus \Gamma$ and $u \in \mathit{fs}[s]$, then there exists $u' \in \mathit{fs}[s']$ such that $u \xrightarrow{\sigma} u'$ and $\sigma\in (\Sigma_2\setminus\Gamma)^*$.  
%where $a = a_1, a_2, ..., a_n$ such that for all $i \in [1,n]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. Moreover, $a$ could be the empty sequence.
\end{itemize}
\end{definition}
%If $\mathit{fs}[s]$ is a unique state for all $s \in Q_1$ then $\mathit{fs}$ is called a refinement mapping/function. 
With normal $\Gamma$-forward simulations, a step of $L_1$ labeled by a call, resp., return, action is simulated by a sequence of steps of $L_2$ that start, resp., end, with the same action, and a step of $L_1$ labeled by another observable action should be matched by a step of $L_2$ labeled by the same action. The rest of the transitions in $L_1$ are matched to a possibly empty sequence of transitions of $L_2$ with arbitrary labels.

A dual notion of forward simulation is the backward simulation:
\begin{definition}\label{def:back_app}
Let $L_1=(Q_1,\Sigma, s_0^1, \delta_1)$ and $L_2=(Q_2,\Sigma, s_0^2, \delta_2)$ be two libraries over a common alphabet $\Sigma$, and $\Gamma\subseteq \Sigma$ a set of actions such that $(C\cup R)\subseteq \Gamma$. A relation $bs \subseteq Q_1 \times Q_2$ is called a \emph{normal $\Gamma$-backward simulation} from $L_1$ to $L_2$ iff the following holds:
\begin{itemize}
\item[(i)] $bs[s_0^1] = \{s_0^2 \}$
\item[(ii-a)] If $(s,c,s') \in \delta_1$, for some $c\in C$, and $u' \in bs[s']$, then there exists $u \in bs[s]$ such that $u \xrightarrow{@s} u'$, $@s_0=c$, and $@s_i\in \Sigma\setminus\Gamma$, for each $0<i<|@s|$.
% where $a = a_1, a_2, ..., a_n$ such that $a_1 = inv(m,d,k)$ and for all $i \in [2,n]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. 
\item[(ii-b)] If $(s,r,s') \in \delta_1$, for some $r\in R$, and $u' \in bs[s']$, then there exists $u \in bs[s]$ such that $u \xrightarrow{@s} u'$, $@s_{|@s| -1}=r$, and $@s_i\in \Sigma\setminus\Gamma$, for each $0\leq i<|@s| -1$.
%where $a = a_1, a_2, ..., a_n$ such that $a_n = ret(m,d,k)$ and for all $i \in [1,n-1]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. 
\item[(ii-c)] If $(s,\gamma, s') \in \delta_1$, for some $\gamma\in \Gamma\setminus (C\cup R)$, and $u' \in bs[s']$, then there exists $u \in bs[s]$ such that $\delta_2(u,\gamma,u')$
\item[(ii-d)] If $(s,e,s') \in \delta_1$ for some $e \in \Sigma\setminus \Gamma$ and $u' \in bs[s']$, then there exists $u \in bs[s]$ such that $u \xrightarrow{@s} u'$ and $\sigma\in (\Sigma_2\setminus\Gamma)^*$.
%where $a = a_1, a_2, ..., a_n$ such that for all $i \in [1,n]$, $a_i \in \Sigma_{L_2} \backslash A\Sigma $. Moreover, $a$ could be the empty sequence.
\end{itemize}
\end{definition}

%\begin{lem}
%Let $L_1$ and $L_2$ be two libraries over a common alphabet $\Sigma$, and $\Gamma\subseteq \Sigma$ a set of actions such that $(C\cup R)\subseteq \Gamma$. $L_1$ $\Gamma$-refines $L_2$ if{f} there exists a $\Gamma$-backward simulation from $L_1$ to $L_2$.
%\end{lem}
%\begin{proof}
%Looks trivial and follows Lynch paper. Can be completed later.
%\end{proof}
